name: CyberPulse - Mise Ã  jour quotidienne

on:
  schedule:
    # ExÃ©cution chaque jour Ã  08:00 UTC
    - cron: '0 8 * * *'
  
  # Permet le dÃ©clenchement manuel
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-news:
    name: ðŸ“° GÃ©nÃ©ration du Flash Info Cyber
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # PrÃ©paration de l'environnement
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Installation de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------------------------------------------------
      # GÃ©nÃ©ration du contenu
      # -----------------------------------------------------------------------
      - name: ðŸ” ExÃ©cution de CyberPulse
        env:
          # ClÃ©s API configurÃ©es dans les secrets du repository
          OPENAI_API_KEY: ${{ secrets.OPEN_AI_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_KEY }}
        run: |
          cd src
          python main.py

      # -----------------------------------------------------------------------
      # Publication des changements
      # -----------------------------------------------------------------------
      - name: ðŸ“¤ Commit et push des fichiers gÃ©nÃ©rÃ©s
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ajouter les fichiers gÃ©nÃ©rÃ©s (chemin adaptÃ© au portfolio)
          git add cyber-news/data.json cyber-news/audio/latest_briefing.mp3
          
          # VÃ©rifier s'il y a des changements Ã  committer
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Aucun changement Ã  committer"
          else
            git commit -m "ðŸ›¡ï¸ Flash info du $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          fi

      # -----------------------------------------------------------------------
      # RÃ©sumÃ©
      # -----------------------------------------------------------------------
      - name: âœ… RÃ©sumÃ© de l'exÃ©cution
        run: |
          echo "## ðŸ›¡ï¸ CyberPulse - Mise Ã  jour terminÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Information | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“… Date | $(date -u +'%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Statut | SuccÃ¨s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fichiers gÃ©nÃ©rÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- \`cyber-news/data.json\` - MÃ©tadonnÃ©es et articles" >> $GITHUB_STEP_SUMMARY
          echo "- \`cyber-news/audio/latest_briefing.mp3\` - Podcast audio" >> $GITHUB_STEP_SUMMARY
